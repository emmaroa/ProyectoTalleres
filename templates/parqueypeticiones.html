<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gestión Talleres · Vehículos & Peticiones</title>
  <style>
    :root{
      --orange:#ff7f11; --orange-700:#f57c00; --teal:#07b1bc;
      --bg:#f6f7f8; --ink:#212529; --muted:#6b7280; --surface:#ffffff; --border:#e5e7eb;
      --radius:14px; --shadow:0 8px 24px rgba(0,0,0,.06);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial;color:var(--ink);background:
      radial-gradient(900px 500px at -10% -10%, rgba(253,147,25,.10), transparent 40%),
      radial-gradient(900px 500px at 110% 0%, rgba(7,177,188,.12), transparent 40%),
      linear-gradient(180deg,#fcfdfd,#f3f7f8)}
    header{position:sticky;top:0;z-index:5;background:rgba(255,255,255,.75);backdrop-filter:saturate(160%) blur(8px);border-bottom:1px solid var(--border)}
    .bar{display:flex;gap:16px;align-items:center;justify-content:space-between;max-width:1200px;margin:0 auto;padding:12px 16px}
    .brand{display:flex;gap:10px;align-items:center}
    .dot{width:12px;height:12px;border-radius:999px;background:var(--orange);box-shadow:0 0 0 4px rgba(255,127,17,.15)}
    .brand h1{font-size:18px;margin:0}
    .api-box{display:flex;gap:8px;align-items:center}
    .api-box input{padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:var(--surface)}
    nav.main{border-bottom:1px solid var(--border);background:#fff}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;max-width:1200px;margin:0 auto;padding:10px 16px}
    .tab{padding:9px 12px;border:1px solid var(--border);border-radius:999px;background:#fff;cursor:pointer}
    .tab.active{background:var(--orange);color:#fff;border-color:transparent}

    main{max-width:1200px;margin:18px auto 36px;padding:0 16px}
    .panel{display:none}
    .panel.active{display:block}

    .layout{display:grid;grid-template-columns:320px 1fr;gap:14px}
    @media (max-width:980px){.layout{grid-template-columns:1fr}}

    .card{border:1px solid var(--border);border-radius:12px;background:#fff;box-shadow:var(--shadow)}
    .card .hd{padding:12px 14px;border-bottom:1px solid var(--border);font-weight:700}
    .card .bd{padding:12px 14px}

    .field{display:grid;gap:6px;margin-bottom:10px}
    .field label{font-size:12px;color:var(--muted)}
    .field input,.field select,.field textarea{padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff}
    .btn{appearance:none;border:0;border-radius:12px;padding:10px 14px;background:var(--orange);color:#fff;cursor:pointer;box-shadow:var(--shadow);font-weight:600}
    .btn.ghost{background:transparent;color:var(--ink);border:1px solid var(--border);box-shadow:none}
    .btn.small{padding:8px 10px;border-radius:10px}
    .btn.teal{background:var(--teal)}

    table{width:100%;border-collapse:collapse;border:1px solid var(--border)}
    th,td{border-bottom:1px solid var(--border);padding:10px;text-align:left;vertical-align:top}
    th{font-size:12px;color:var(--muted);background:#fafafa}
    tbody tr:hover{background:#fff9f3}

    .col-actions{width:160px}
    .actions-col{display:flex;flex-direction:column;gap:8px}

    .pill{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;font-weight:700}
    .pill.pend{background:#fff2e8;color:#b45309}
    .pill.tram{background:#eef7ff;color:#1d4ed8}
    .pill.ped{background:#fff1f2;color:#9d174d}
    .pill.ent{background:#ecfdf5;color:#065f46}

    dialog{border:none;border-radius:16px;box-shadow:0 16px 40px rgba(0,0,0,.18)}
    dialog::backdrop{background:rgba(0,0,0,.3)}
    .hint{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="brand">
        <span class="dot"></span>
        <h1>Gestión Talleres · Vehículos & Peticiones</h1>
      </div>
      <div class="api-box">
        <span class="hint">API:</span>
        <input id="apiBase" value="http://127.0.0.1:8000" size="28"/>
        <button class="btn ghost" id="btnPing">Probar</button>
      </div>
    </div>
    <nav class="main">
      <div class="tabs">
        <button class="tab" data-route="#vehiculos">Consulta Parque Vehicular</button>
        <button class="tab" data-route="#vehiculo-alta">Alta de Vehículo</button>
        <button class="tab" data-route="#peticiones-consulta">Peticiones · Consulta</button>
        <button class="tab" data-route="#peticiones-captura">Peticiones · Captura</button>
        <button class="tab" data-route="#peticiones-admin">Peticiones · Administración</button>
      </div>
    </nav>
  </header>

  <main>
    <!-- 1) CONSULTA PARQUE VEHICULAR: buscar por últimos 5, con botones a la izquierda -->
    <section class="panel" id="vehiculos">
      <div class="layout">
        <div class="card">
          <div class="hd">Buscar por últimos 5 del inventario</div>
          <div class="bd">
            <div class="field">
              <label>Últimos 5 dígitos</label>
              <input id="v_last5" maxlength="5" placeholder="Ej. 12345" />
            </div>
            <button class="btn" id="v_btnBuscar">Buscar</button>
            <div class="hint" style="margin-top:8px">Coincidencias por <b>inventario_veh</b> que contenga esos 5 dígitos.</div>
          </div>
        </div>
        <div class="card">
          <div class="hd">Resultados</div>
          <div class="bd" id="v_resultados"></div>
        </div>
      </div>
    </section>

    <!-- 2) ALTA VEHÍCULO: página exclusiva -->
    <section class="panel" id="vehiculo-alta">
      <div class="card">
        <div class="hd">Alta de vehículo</div>
        <div class="bd" style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px">
          <div class="field"><label>Inventario (único)</label><input id="av_inv"/></div>
          <div class="field"><label>Grupo</label><input id="av_grupo"/></div>
          <div class="field"><label>Descripción</label><input id="av_desc"/></div>
          <div class="field"><label>Dependencia</label><input id="av_dep"/></div>
          <div class="field"><label>Marca</label><input id="av_marca"/></div>
          <div class="field"><label>Modelo</label><input id="av_modelo"/></div>
          <div class="field"><label>Color</label><input id="av_color"/></div>
          <div class="field"><label>Placas</label><input id="av_placas"/></div>
          <div class="field"><label>Serie (VIN)</label><input id="av_serie"/></div>
          <div class="field"><label>Factura</label><input id="av_factura"/></div>
          <div class="field"><label>Fecha alta</label><input id="av_falta" type="date"/></div>
          <div class="field"><label>Estatus</label>
            <select id="av_estatus"><option>ACTIVO</option><option>BAJA</option><option>EN TRAMITE DE BAJA</option></select>
          </div>
          <div class="field" style="grid-column:1/-1"><label>Notas</label><textarea id="av_notas" rows="3"></textarea></div>
          <div style="grid-column:1/-1;display:flex;gap:10px">
            <button class="btn" id="btnAltaVeh">Guardar vehículo</button>
            <div id="av_msg" class="hint"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- 3) PETICIONES · CONSULTA (solo vista) -->
    <section class="panel" id="peticiones-consulta">
      <div class="card">
        <div class="hd">Consulta de peticiones</div>
        <div class="bd" style="display:grid;gap:10px">
          <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:10px">
            <div class="field"><label>Estatus</label>
              <select id="pc_estatus"><option value="">(Todos)</option><option>PENDIENTE</option><option>EN TRAMITE</option><option>PEDIDO</option><option>ENTREGADO</option></select>
            </div>
            <div class="field"><label>Dependencia</label><input id="pc_dep"/></div>
            <div class="field"><label>Proveedor ID</label><input id="pc_prov" type="number"/></div>
            <div class="field"><label>Unidad (últimos 5)</label><input id="pc_unidad" maxlength="5"/></div>
            <div class="field"><label>Rango fechas (desde)</label><input id="pc_desde" type="date"/></div>
          </div>
          <div><button class="btn" id="pc_buscar">Buscar</button> <button class="btn ghost" id="pc_limpiar">Limpiar</button></div>
          <div id="pc_resultados"></div>
        </div>
      </div>
    </section>

    <!-- 4) PETICIONES · CAPTURA -->
    <section class="panel" id="peticiones-captura">
      <div class="card">
        <div class="hd">Capturar petición</div>
        <div class="bd" style="display:grid;gap:10px">
          <div class="field"><label>Últimos 5 del inventario</label><input id="cap_last5" maxlength="5" placeholder="Ej. 12345"/></div>
          <div class="field"><label>Seleccionar vehículo</label>
            <select id="cap_veh"></select>
            <div class="hint">Busca coincidencias y elige el vehículo correcto.</div>
          </div>
          <div class="field"><label>Petición</label><textarea id="cap_pet" rows="3" placeholder="Describe refacciones"></textarea></div>
          <div class="field"><label>Quién solicita</label><input id="cap_sol" placeholder="Nombre del mecánico"/></div>
          <div class="field"><label>¿Se deja muestra?</label><select id="cap_muestra"><option value="0">No</option><option value="1">Sí</option></select></div>
          <div><button class="btn" id="cap_guardar">Guardar petición</button> <span id="cap_msg" class="hint"></span></div>
        </div>
      </div>
    </section>

    <!-- 5) PETICIONES · ADMINISTRACIÓN (tabla editable en línea) -->
    <section class="panel" id="peticiones-admin">
      <div class="card">
        <div class="hd">Administración de peticiones</div>
        <div class="bd">
          <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px">
            <button class="btn" id="pa_recargar">Recargar</button>
            <div class="hint">Edita directamente en la tabla: estatus y proveedor, luego pulsa "Guardar cambios" en cada fila.</div>
          </div>
          <div id="pa_tabla"></div>
        </div>
      </div>
    </section>
  </main>

  <!-- MODALES -->
  <dialog id="dlg_detalles">
    <div class="card" style="border:none;box-shadow:none">
      <div class="hd" style="display:flex;justify-content:space-between;align-items:center">Detalles del vehículo <button class="btn ghost small" id="dlg_close">Cerrar</button></div>
      <div class="bd" id="dlg_body"></div>
    </div>
  </dialog>

<script>
const $ = (q) => document.querySelector(q);
const apiBase = () => $('#apiBase').value.trim().replace(/\/$/, '');

// --- Navegación por hash (simula páginas) ---
const routes = ['#vehiculos','#vehiculo-alta','#peticiones-consulta','#peticiones-captura','#peticiones-admin'];
function activate(route){
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  const el = document.querySelector(route);
  if(el){ el.classList.add('active'); }
  document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active', t.dataset.route===route));
}
window.addEventListener('hashchange', ()=>activate(location.hash||'#vehiculos'));
(document.querySelectorAll('.tab')||[]).forEach(b=>b.addEventListener('click', ()=>{ location.hash=b.dataset.route; }));
activate(location.hash||'#vehiculos');

// --- Utilidades ---
function pill(estatus){
  const map = { 'PENDIENTE':'pend', 'EN TRAMITE':'tram', 'PEDIDO':'ped', 'ENTREGADO':'ent' };
  const cls = map[estatus]||'pend';
  return `<span class="pill ${cls}">${estatus}</span>`;
}
async function ping(){
  try{ const r = await fetch(apiBase()+"/api/health"); const j = await r.json(); alert(j.ok? 'Conectado a la API ✅' : 'No responde ❌'); }catch(e){ alert('Error: '+e.message); }
}
$('#btnPing').addEventListener('click', ping);

// =============== 1) Consulta Parque Vehicular ===============
$('#v_btnBuscar').addEventListener('click', buscarVehiculosPor5);
$('#v_last5').addEventListener('keyup', e=>{ if(e.key==='Enter') buscarVehiculosPor5(); });

async function buscarVehiculosPor5(){
  const last5 = $('#v_last5').value.trim();
  if(!last5) return alert('Escribe los últimos 5 dígitos');
  // usamos /api/vehiculos?search=%last5% (coincide contra inventario/placa/serie)
  const url = apiBase()+`/api/vehiculos?search=${encodeURIComponent(last5)}`;
  const r = await fetch(url); const data = await r.json();
  const box = $('#v_resultados');
  if(!data.length){ box.innerHTML = '<div class="hint">Sin resultados</div>'; return; }
  box.innerHTML = `<div style="overflow:auto"><table>
    <thead><tr><th class="col-actions">Acciones</th><th>ID</th><th>Inventario</th><th>Dependencia</th><th>Marca</th><th>Modelo</th><th>Color</th><th>Placas</th><th>Serie</th><th>Estatus</th></tr></thead>
    <tbody>
      ${data.map(v=>`<tr>
        <td class="actions-col">
          <div class="actions-col">
            <button class="btn teal small" onclick="verDetalles(${v.id})">Ver detalles</button>
            <button class="btn small" onclick="irModVeh(${v.id})">Modificación</button>
          </div>
        </td>
        <td>${v.id}</td>
        <td>${v.inventario_veh}</td>
        <td>${v.dependencia||''}</td>
        <td>${v.marca||''}</td>
        <td>${v.modelo||''}</td>
        <td>${v.color||''}</td>
        <td>${v.placas||''}</td>
        <td>${v.serie||''}</td>
        <td>${v.estatus||''}</td>
      </tr>`).join('')}
    </tbody></table></div>`;
}

async function verDetalles(id){
  const r = await fetch(apiBase()+`/api/vehiculos/${id}`);
  if(!r.ok) return alert('No se pudo cargar');
  const v = await r.json();
  const b = $('#dlg_body');
  b.innerHTML = `<div class="field"><label>Inventario</label><div>${v.inventario_veh||''}</div></div>
  <div class="field"><label>Descripción</label><div>${v.descripcion||''}</div></div>
  <div class="field"><label>Dependencia</label><div>${v.dependencia||''}</div></div>
  <div class="field"><label>Marca/Modelo</label><div>${[v.marca,v.modelo].filter(Boolean).join(' ')}</div></div>
  <div class="field"><label>Color</label><div>${v.color||''}</div></div>
  <div class="field"><label>Placas</label><div>${v.placas||''}</div></div>
  <div class="field"><label>Serie (VIN)</label><div>${v.serie||''}</div></div>
  <div class="field"><label>Factura</label><div>${v.factura||''}</div></div>
  <div class="field"><label>Alta</label><div>${v.fecha_alta||''}</div></div>
  <div class="field"><label>Estatus</label><div>${v.estatus||''}</div></div>
  <div class="field"><label>Baja</label><div>${v.fecha_baja||''}</div></div>
  <div class="field"><label>Notas</label><div>${v.notas||''}</div></div>`;
  $('#dlg_detalles').showModal();
}
$('#dlg_close').addEventListener('click',()=>$('#dlg_detalles').close());

function irModVeh(id){
  // reciclamos la sección de Alta para edición rápida (o podríamos crear una vista exclusiva). Aquí usamos el modal de detalles para edición inline.
  // Para seguir tu especificación de "botón de modificación" abrimos un formulario en modal con los campos editables.
  editarVehiculo(id);
}

async function editarVehiculo(id){
  const r = await fetch(apiBase()+`/api/vehiculos/${id}`);
  if(!r.ok) return alert('No se pudo cargar');
  const v = await r.json();
  const b = $('#dlg_body');
  b.innerHTML = `
  <div class="field"><label>Inventario</label><input id="e_inv" value="${v.inventario_veh||''}"></div>
  <div class="field"><label>Dependencia</label><input id="e_dep" value="${v.dependencia||''}"></div>
  <div class="field"><label>Marca</label><input id="e_marca" value="${v.marca||''}"></div>
  <div class="field"><label>Modelo</label><input id="e_modelo" value="${v.modelo||''}"></div>
  <div class="field"><label>Color</label><input id="e_color" value="${v.color||''}"></div>
  <div class="field"><label>Placas</label><input id="e_placas" value="${v.placas||''}"></div>
  <div class="field"><label>Serie (VIN)</label><input id="e_serie" value="${v.serie||''}"></div>
  <div class="field"><label>Estatus</label>
    <select id="e_estatus"><option ${v.estatus==='ACTIVO'?'selected':''}>ACTIVO</option><option ${v.estatus==='BAJA'?'selected':''}>BAJA</option><option ${v.estatus==='EN TRAMITE DE BAJA'?'selected':''}>EN TRAMITE DE BAJA</option></select>
  </div>
  <div class="field"><label>Fecha alta</label><input id="e_falta" type="date" value="${(v.fecha_alta||'').slice(0,10)}"></div>
  <div class="field"><label>Fecha baja</label><input id="e_fbaja" type="date" value="${(v.fecha_baja||'').slice(0,10)}"></div>
  <div class="field"><label>Notas</label><textarea id="e_notas" rows="3">${v.notas||''}</textarea></div>
  <div><button class="btn" id="e_guardar">Guardar cambios</button></div>`;
  $('#dlg_detalles').showModal();
  $('#e_guardar').addEventListener('click', async()=>{
    const payload = {
      inventario_veh: $('#e_inv').value,
      dependencia: $('#e_dep').value,
      marca: $('#e_marca').value,
      modelo: $('#e_modelo').value,
      color: $('#e_color').value,
      placas: $('#e_placas').value,
      serie: $('#e_serie').value,
      estatus: $('#e_estatus').value,
      fecha_alta: $('#e_falta').value || null,
      fecha_baja: $('#e_fbaja').value || null,
      notas: $('#e_notas').value
    };
    const rr = await fetch(apiBase()+`/api/vehiculos/${id}`,{method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
    const j = await rr.json();
    alert(j.updated? 'Vehículo actualizado ✅' : 'Sin cambios');
    $('#dlg_detalles').close();
  });
}

// =============== 2) Alta Vehículo ===============
$('#btnAltaVeh').addEventListener('click', async()=>{
  const payload = {
    inventario_veh: $('#av_inv').value, grupo: $('#av_grupo').value, descripcion: $('#av_desc').value,
    dependencia: $('#av_dep').value, marca: $('#av_marca').value, modelo: $('#av_modelo').value,
    color: $('#av_color').value, placas: $('#av_placas').value, serie: $('#av_serie').value,
    factura: $('#av_factura').value, fecha_alta: $('#av_falta').value || new Date().toISOString().slice(0,10),
    estatus: $('#av_estatus').value, fecha_baja: null, notas: $('#av_notas').value
  };
  const r = await fetch(apiBase()+`/api/vehiculos`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
  const j = await r.json();
  $('#av_msg').textContent = j.id? `Guardado ✅ (ID ${j.id})` : 'Revisa los datos';
});

// =============== 3) Peticiones · Consulta ===============
$('#pc_buscar').addEventListener('click', cargarPeticionesConsulta);
$('#pc_limpiar').addEventListener('click', ()=>{ ['pc_estatus','pc_dep','pc_prov','pc_unidad','pc_desde'].forEach(id=>$('#'+id).value=''); cargarPeticionesConsulta(); });
async function cargarPeticionesConsulta(){
  const p = new URLSearchParams();
  const e = $('#pc_estatus').value; if(e) p.set('estatus', e);
  const d = $('#pc_dep').value; if(d) p.set('dependencia', d);
  const pr = $('#pc_prov').value; if(pr) p.set('proveedor_id', pr);
  const u = $('#pc_unidad').value; if(u) p.set('unidad', u);
  const f = $('#pc_desde').value; if(f) p.set('date_from', f);
  const r = await fetch(apiBase()+`/api/peticiones?${p.toString()}`); const data = await r.json();
  const box = $('#pc_resultados');
  if(!data.length){ box.innerHTML = '<div class="hint">Sin resultados</div>'; return; }
  box.innerHTML = `<div style="overflow:auto"><table>
    <thead><tr><th>ID</th><th>Fecha</th><th>Estatus</th><th>Unidad</th><th>Inventario</th><th>Dep.</th><th>Vehículo</th><th>Petición</th><th>Solicitante</th><th>Proveedor</th></tr></thead>
    <tbody>${data.map(p=>`<tr>
      <td>${p.id}</td><td>${new Date(p.created_at).toLocaleString()}</td><td>${pill(p.estatus)}</td>
      <td>${p.unidad_last5||''}</td><td>${p.inventario_veh||''}</td><td>${p.dependencia||''}</td>
      <td>${[p.marca,p.modelo].filter(Boolean).join(' ')}</td><td>${p.peticion||''}</td><td>${p.solicitante||''}</td><td>${p.proveedor||''}</td>
    </tr>`).join('')}</tbody></table></div>`;
}

// =============== 4) Peticiones · Captura ===============
$('#cap_last5').addEventListener('keyup', e=>{ if(e.key==='Enter') buscarVehiculoParaCaptura(); });
async function buscarVehiculoParaCaptura(){
  const last5 = $('#cap_last5').value.trim();
  if(!last5) return alert('Escribe los últimos 5');
  const r = await fetch(apiBase()+`/api/vehiculos?search=${encodeURIComponent(last5)}`);
  const data = await r.json();
  const sel = $('#cap_veh');
  if(!data.length){ sel.innerHTML = '<option>(Sin coincidencias)</option>'; return; }
  sel.innerHTML = data.map(v=>`<option value="${v.id}">${v.id} · ${v.inventario_veh} · ${v.dependencia||''} · ${v.marca||''} ${v.modelo||''}</option>`).join('');
}
$('#cap_last5').addEventListener('change', buscarVehiculoParaCaptura);

$('#cap_guardar').addEventListener('click', async()=>{
  const vehiculo_id = parseInt($('#cap_veh').value||'0',10);
  if(!vehiculo_id){ alert('Selecciona un vehículo'); return; }
  const payload = { vehiculo_id, unidad_last5:'XXXXX', peticion: $('#cap_pet').value, solicitante: $('#cap_sol').value, deja_muestra: +$('#cap_muestra').value, estatus:'PENDIENTE', proveedor_id: null };
  const r = await fetch(apiBase()+`/api/peticiones`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
  const j = await r.json();
  $('#cap_msg').textContent = j.id? `Guardado ✅ (Folio ${j.id})` : 'Revisa los datos';
});

// =============== 5) Peticiones · Administración (editable en tabla) ===============
$('#pa_recargar').addEventListener('click', cargarAdminPeticiones);
async function cargarAdminPeticiones(){
  const r = await fetch(apiBase()+`/api/peticiones?limit=200`);
  const data = await r.json();
  const box = $('#pa_tabla');
  if(!data.length){ box.innerHTML = '<div class="hint">No hay peticiones</div>'; return; }
  // Cargar proveedores para selects
  const pr = await (await fetch(apiBase()+`/api/proveedores`)).json();
  const provOpts = ['<option value="">(Sin proveedor)</option>'].concat(pr.map(p=>`<option value="${p.id}">${p.id} · ${p.nombre}</option>`)).join('');

  box.innerHTML = `<div style="overflow:auto"><table>
    <thead><tr><th>ID</th><th>Fecha</th><th>Estatus</th><th>Proveedor</th><th>Unidad</th><th>Inventario</th><th>Dep.</th><th>Petición</th><th>Solicitante</th><th>Guardar</th></tr></thead>
    <tbody>
      ${data.map(p=>`<tr>
        <td>${p.id}</td>
        <td>${new Date(p.created_at).toLocaleString()}</td>
        <td>
          <select data-k="estatus" data-id="${p.id}">
            ${['PENDIENTE','EN TRAMITE','PEDIDO','ENTREGADO'].map(x=>`<option ${x===p.estatus?'selected':''}>${x}</option>`).join('')}
          </select>
        </td>
        <td>
          <select data-k="proveedor_id" data-id="${p.id}">${provOpts.replace(`value="${p.proveedor_id||''}"`, `value="${p.proveedor_id||''}" selected`)}</select>
        </td>
        <td>${p.unidad_last5||''}</td>
        <td>${p.inventario_veh||''}</td>
        <td>${p.dependencia||''}</td>
        <td>${p.peticion||''}</td>
        <td>${p.solicitante||''}</td>
        <td><button class="btn small" onclick="guardarFila(${p.id})">Guardar cambios</button></td>
      </tr>`).join('')}
    </tbody></table></div>`;
}

async function guardarFila(id){
  const rowSel = (k) => document.querySelector(`[data-k="${k}"][data-id="${id}"]`);
  const estatus = rowSel('estatus').value;
  const proveedor_id_val = rowSel('proveedor_id').value;
  const proveedor_id = proveedor_id_val? parseInt(proveedor_id_val,10): null;
  const payload = { estatus, proveedor_id };
  const r = await fetch(apiBase()+`/api/peticiones/${id}`, {method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
  const j = await r.json();
  alert(j.updated? 'Actualizado ✅' : 'Sin cambios');
}

// Inicializaciones por defecto
if(location.hash==='#peticiones-admin'){ cargarAdminPeticiones(); }
</script>
</body>
</html>
